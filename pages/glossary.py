import streamlit as st
import pandas as pd

st.set_page_config(page_title="系統說明書", layout="wide")

st.title("📘 台股在地化量化系統說明書")
st.markdown("""
本系統依據 **《股票分析軟體架構精進研究報告》** 與 **《台股在地化修正指南》** 構建。
核心邏輯在於將華爾街大師策略進行「在地化修正」，以適應台股特有的高殖利率、月營收發布與籌碼結構。
""")

# --- 第一部分：在地化估值模型 ---
st.header("1. 台股在地化估值模型 (Localized Valuation)")
st.info("總分越高，代表買進訊號越強烈。本系統結合「基本面體質」與「在地化動能」。")

# 建立評分邏輯表
score_data = {
    "維度": [
        "基本面 (F-Score)", "基本面 (F-Score)", 
        "風險 (Z-Score)", 
        "價值 (Graham)", "價值 (Graham)",
        "成長 (Lynch)", "成長 (Lynch)",
        "品質 (Magic)",
        "在地化 (Revenue)", "在地化 (Revenue)",
        "在地化 (Chips)", "在地化 (Chips)",
        "流動性 (Liquidity)"
    ],
    "判斷邏輯": [
        "F-Score ≥ 8 分", "F-Score ≤ 3 分",
        "Z-Score < 1.81",
        "現價 < 葛拉漢數 (且流動比>1.5)", "現價 < 葛拉漢數 (流動比不足)",
        "PEG < 0.5 (極度低估)", "PEG < 1.0 (合理)",
        "ROC > 20% 且 盈餘殖利率 > 5%",
        "營收 YoY > 20% & MoM > 0", "營收 YoY > 20%",
        "投信積極認養 (中小型股)", "外資連續 3 日買超",
        "日均量 < 500 張"
    ],
    "分數": [
        "+2", "-2",
        "-3 (重扣)",
        "+2", "+1",
        "+2", "+1",
        "+2",
        "+2", "+1",
        "+2", "+1",
        "-2 (扣分)"
    ]
}

df_score = pd.DataFrame(score_data)
st.table(df_score)

st.divider()

# --- 第二部分：華爾街大師指標詳解 ---
st.header("2. 華爾街大師指標 (Guru Metrics)")

with st.expander("💎 班傑明·葛拉漢 (Benjamin Graham) - 防禦型價值"):
    st.markdown("""
    **核心哲學：** 買進價格低於內在價值的公司，並要求極高的安全邊際。
    
    **公式與修正：**
    * **葛拉漢數 (Graham Number):** $\sqrt{22.5 \\times \\text{5年平均EPS} \\times \\text{每股淨值}}$
    * [cite_start]**在地化修正[cite: 296]:** 為了平滑台股電子業的景氣循環，本系統強制使用 **「過去 5 年 (20 季) 平均 EPS」**，而非單一年度獲利。這能避免在景氣最高峰誤判股價便宜。
    * **策略：** 若現價低於此數值，且公司財務健康 (流動比率 > 1.5)，視為深度價值股。
    """)

with st.expander("🚀 彼得·林區 (Peter Lynch) - 成長價值"):
    st.markdown("""
    **核心哲學：** 尋找成長率高於本益比的股票 (GARP)。
    
    **公式與修正：**
    * **Yield-Adjusted PEG:** $\\frac{P/E}{\\text{營收成長率} + \\text{股息殖利率}}$
    * [cite_start]**在地化修正 [cite: 319-321]:** 台股具有高殖利率特性 (平均 4%~5%)。若直接用美股 PEG 公式會低估台股價值。本系統將 **股息殖利率** 加回分母，正確反映台股的總報酬潛力。
    * **判讀：** < 1.0 為合理，< 0.5 為極度低估。
    """)

with st.expander("✨ 喬爾·葛林布雷 (Magic Formula) - 神奇公式"):
    st.markdown("""
    **核心哲學：** 用便宜的價格買進好公司。
    
    [cite_start]**雙因子模型 [cite: 338-343]:**
    1.  **好公司 (ROC):** 資本報酬率 = EBIT / (固定資產 + 營運資金)。
    2.  **便宜價格 (Earnings Yield):** 盈餘殖利率 = EBIT / 企業價值 (EV)。
    * **策略：** 系統要求 **ROC > 20%** (高品質) 且 **盈餘殖利率 > 5%** (價格不貴) 同時成立才給分。
    """)

st.divider()

# --- 第三部分：台股在地化因子 ---
st.header("3. 台股特有因子 (Taiwan Localization)")

with st.expander("📈 月營收動能 (Monthly Revenue Alpha)"):
    st.markdown("""
    [cite_start]**差異分析 [cite: 8-9]:**
    * **美股：** 依賴季報 (10-Q)，資訊落後。
    * **台股：** 每月 10 日強制公佈營收，具有極強的領先性。
    
    **策略邏輯：** * **營收雙強：** 當 **年增率 (YoY) > 20%** 且 **月增率 (MoM) > 0%** 時，代表長線成長趨勢確立且短線動能未歇，是台股最強的 Alpha 訊號之一。
    """)

with st.expander("💰 三大法人籌碼 (Institutional Chips)"):
    st.markdown("""
    [cite_start]**差異分析[cite: 69]:**
    * **美股：** 13F 報告每季揭露，延遲 45 天。
    * **台股：** 每日盤後揭露三大法人買賣超。
    
    [cite_start]**策略邏輯 [cite: 74, 83-84]:**
    * **外資 (Foreign):** 資金量大，連續買超通常代表波段趨勢 (Beta)。
    * **投信 (Trust):** 追求績效，偏好認養 **中小型成長股**。當投信開始買進股本小的公司時，往往隱含作帳行情 (Alpha)。
    """)

st.divider()

# --- 第四部分：操作與風險 ---
st.header("4. 操作建議與風險控制")
st.warning("⚠️ 交易台股須注意「流動性陷阱」與「高交易成本」。")

st.markdown("""
#### [cite_start]🛡️ 延遲與滑價對策 [cite: 15, 98-102]
本系統使用免費數據源，盤中可能存在 20 分鐘延遲。
1.  **盤後佈局 (推薦):** 每日收盤後執行分析，掛入次日開盤限價單。
2.  **ROD 策略:** 若需盤中進場，建議於 **13:25 試撮合階段** 掛入 ROD 限價單。
3.  **漲跌停限制:** 台股有 ±10% 限制。若預測漲停，需提早掛單；若量縮鎖死，切勿市價追進。

#### [cite_start]💸 交易成本 [cite: 17-22]
* **台股成本:** 賣出需付 **0.3% 證交稅** + 手續費，來回成本約 **0.5%**。
* **策略影響:** 嚴禁高頻交易 (High Frequency Trading)。本系統設計為波段策略，期望單次獲利 > 5% 以覆蓋成本。
""")
